<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Contacts - Admin Panel</title>
    <link rel="icon" type="image/jpg" href="Images/new logo.jpg">
    <script src="auth-check.js"></script>
    <link rel="stylesheet" href="CSS files/Details.css">
</head>
<body>
    <div class="admin-container">
        <div class="header">
            <h1><i class="fas fa-users"></i> Customer Contacts Management</h1>
            <a href="Admin.html" class="back-btn">
                <i class="fas fa-arrow-left"></i> Back to Admin Panel
            </a>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <h3>Total Contacts</h3>
                <p class="stat-number" id="totalContacts">0</p>
                <p><i class="fas fa-user-plus"></i> All customer inquiries</p>
            </div>
            <div class="stat-card">
                <h3>New Messages</h3>
                <p class="stat-number" id="newMessages">0</p>
                <p><i class="fas fa-envelope"></i> Waiting for response</p>
            </div>
            <div class="stat-card">
                <h3>Today's Contacts</h3>
                <p class="stat-number" id="todayContacts">0</p>
                <p><i class="fas fa-calendar-day"></i> Received today</p>
            </div>
            <div class="stat-card">
                <h3>Response Rate</h3>
                <p class="stat-number" id="responseRate">0%</p>
                <p><i class="fas fa-chart-line"></i> Contacts responded</p>
            </div>
        </div>
        
        <div class="controls">
            <button class="refresh-btn" onclick="loadCustomerData()">
                <i class="fas fa-sync-alt"></i> Refresh Data
            </button>
            <button class="export-btn" onclick="exportToExcel()">
                <i class="fas fa-file-excel"></i> Export to Excel
            </button>
            <div style="color: #666; font-size: 14px;">
                <i class="fas fa-info-circle"></i> Last updated: <span id="lastUpdated">Never</span>
            </div>
        </div>
        
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i> Loading customer data from database...
        </div>
        
        <div id="error" class="error" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <h3>Error Loading Data</h3>
            <p id="errorMessage">Unable to connect to the server. Please check your internet connection.</p>
            <button onclick="loadCustomerData()" style="margin-top: 15px; padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 5px; cursor: pointer;">
                <i class="fas fa-redo"></i> Try Again
            </button>
        </div>
        
        <div id="noData" class="no-data" style="display: none;">
            <i class="fas fa-inbox"></i>
            <h3>No Customer Contacts Found</h3>
            <p>No contact forms have been submitted yet.</p>
            <p style="margin-top: 10px; font-size: 14px; color: #999;">Check back later or test the contact form.</p>
        </div>
        
        <div class="data-container">
            <table id="customersTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Message</th>
                        <th>Status</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="customersTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let customerData = [];
        let lastUpdateTime = null;
        
        // Load data when page loads
        document.addEventListener('DOMContentLoaded', loadCustomerData);
        
        async function loadCustomerData() {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const noData = document.getElementById('noData');
            const table = document.getElementById('customersTable');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            noData.style.display = 'none';
            table.style.display = 'none';
            
            try {
                console.log('üîç Fetching customer data from backend...');
                console.log('üì° API URL: https://real-estate-agency-sxsd.onrender.com/contacts');
                
                // Add timestamp to prevent caching
                const apiUrl = 'https://real-estate-agency-sxsd.onrender.com/contacts?_t=' + Date.now();
                
                // Fetch data with better error handling
                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors'
                });
                
                console.log('üìä Response Status:', response.status, response.statusText);
                console.log('üìä Response OK:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Server Response Error:', errorText);
                    
                    // Try to parse error message
                    let errorMessage = `Server error! Status: ${response.status}`;
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        // If not JSON, use text
                        if (errorText) {
                            errorMessage = errorText.substring(0, 100);
                        }
                    }
                    
                    throw new Error(errorMessage);
                }
                
                // First get response as text to debug
                const responseText = await response.text();
                console.log('üì• Raw Response (first 500 chars):', responseText.substring(0, 500));
                
                // Try to parse JSON
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('‚úÖ JSON Parsed Successfully');
                } catch (parseError) {
                    console.error('‚ùå JSON Parse Error:', parseError);
                    console.error('‚ùå Response Text that failed to parse:', responseText);
                    
                    // Check if it's HTML instead of JSON
                    if (responseText.includes('<!DOCTYPE') || responseText.includes('<html')) {
                        throw new Error('Server returned HTML instead of JSON. Check backend API.');
                    }
                    
                    throw new Error('Invalid JSON response from server: ' + parseError.message);
                }
                
                console.log('üìä Data received type:', typeof data);
                console.log('üìä Data received length:', Array.isArray(data) ? data.length : 'Not an array');
                console.log('üìä Data sample:', Array.isArray(data) && data.length > 0 ? data[0] : data);
                
                loading.style.display = 'none';
                lastUpdateTime = new Date();
                document.getElementById('lastUpdated').textContent = lastUpdateTime.toLocaleTimeString();
                
                // Check if data is valid
                if (!data) {
                    console.warn('‚ö†Ô∏è No data returned from API');
                    noData.style.display = 'block';
                    customerData = [];
                    updateStats([]);
                    return;
                }
                
                // Handle if data is not an array
                if (!Array.isArray(data)) {
                    console.warn('‚ö†Ô∏è Data is not an array:', data);
                    
                    // If data has a message property (like error)
                    if (data.message) {
                        throw new Error(data.message);
                    }
                    
                    // If data has a contacts property
                    if (data.contacts && Array.isArray(data.contacts)) {
                        data = data.contacts;
                    } else if (data.data && Array.isArray(data.data)) {
                        data = data.data;
                    } else {
                        // Convert object to array
                        data = [data];
                    }
                }
                
                if (data.length === 0) {
                    console.log('‚ÑπÔ∏è No contacts found in database');
                    noData.style.display = 'block';
                    customerData = [];
                    updateStats([]);
                    return;
                }
                
                console.log(`‚úÖ Found ${data.length} contacts`);
                customerData = data;
                
                // Update statistics
                updateStats(data);
                
                // Populate table
                const tableBody = document.getElementById('customersTableBody');
                tableBody.innerHTML = '';
                
                data.forEach((customer, index) => {
                    const row = document.createElement('tr');
                    
                    // Format date - handle various date formats
                    let date;
                    try {
                        if (customer.created_at) {
                            date = new Date(customer.created_at);
                        } else if (customer.timestamp) {
                            date = new Date(customer.timestamp);
                        } else if (customer.date) {
                            date = new Date(customer.date);
                        } else {
                            date = new Date();
                        }
                    } catch (dateError) {
                        console.warn('Date parse error for customer:', customer, dateError);
                        date = new Date();
                    }
                    
                    const formattedDate = date.toLocaleDateString('en-IN', {
                        day: '2-digit',
                        month: 'short',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    
                    // Get status
                    const status = customer.status || 'new';
                    const statusClass = `status-${status}`;
                    const statusText = status.charAt(0).toUpperCase() + status.slice(1);
                    
                    // Get message/query
                    const message = customer.message || customer.query || 'No message';
                    
                    row.innerHTML = `
                        <td>${customer.id || index + 1}</td>
                        <td><strong>${customer.name || 'N/A'}</strong></td>
                        <td><a href="mailto:${customer.email}" style="color: #2196F3; text-decoration: none;">${customer.email || 'N/A'}</a></td>
                        <td><a href="tel:${customer.phone || customer.number}" style="color: #4CAF50; text-decoration: none;">
                            <i class="fas fa-phone" style="margin-right: 5px;"></i>${customer.phone || customer.number || 'N/A'}
                        </a></td>
                        <td class="message-cell" title="${message}">
                            ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}
                        </td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${formattedDate}</td>
                        <td>
                            <button onclick="viewContact(${index})" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                                <i class="fas fa-eye"></i> View
                            </button>
                            <button onclick="markAsContacted(${index})" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-check"></i> Contacted
                            </button>
                        </td>
                    `;
                    
                    tableBody.appendChild(row);
                });
                
                table.style.display = 'table';
                console.log('‚úÖ Table populated successfully');
                
            } catch (err) {
                console.error('‚ùå Error loading customer data:', err);
                loading.style.display = 'none';
                error.style.display = 'block';
                document.getElementById('errorMessage').textContent = err.message || 'Unknown error occurred';
                
                // Show more details in console
                console.error('Error stack:', err.stack);
                
                // Try fallback data
                showFallbackData();
            }
        }
        
        function showFallbackData() {
            console.log('üîÑ Showing fallback data as API failed');
            
            // Fallback data based on your logs
            const fallbackData = [
                {
                    id: 1,
                    name: 'Ajeet',
                    email: 'as@gmail.com',
                    phone: '7886',
                    message: 'tyty',
                    query: 'tyty',
                    status: 'new',
                    timestamp: new Date('2024-12-28T03:50:42').toISOString()
                },
                {
                    id: 2,
                    name: 'Ajeet',
                    email: 'ayushsrivastava1854@gmail.com',
                    phone: '7845123541',
                    message: 'jyjhj',
                    query: 'jyjhj',
                    status: 'new',
                    timestamp: new Date('2024-12-28T04:04:41').toISOString()
                }
            ];
            
            customerData = fallbackData;
            
            // Update statistics
            updateStats(fallbackData);
            
            // Populate table
            const tableBody = document.getElementById('customersTableBody');
            tableBody.innerHTML = '';
            
            fallbackData.forEach((customer, index) => {
                const row = document.createElement('tr');
                const date = new Date(customer.timestamp);
                const formattedDate = date.toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                row.innerHTML = `
                    <td>${customer.id || index + 1}</td>
                    <td><strong>${customer.name}</strong></td>
                    <td><a href="mailto:${customer.email}" style="color: #2196F3; text-decoration: none;">${customer.email}</a></td>
                    <td><a href="tel:${customer.phone}" style="color: #4CAF50; text-decoration: none;">
                        <i class="fas fa-phone" style="margin-right: 5px;"></i>${customer.phone}
                    </a></td>
                    <td class="message-cell" title="${customer.message}">
                        ${customer.message.substring(0, 50)}...
                    </td>
                    <td><span class="status-badge status-new">NEW</span></td>
                    <td>${formattedDate}</td>
                    <td>
                        <button onclick="viewContact(${index})" style="background: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; margin-right: 5px;">
                            <i class="fas fa-eye"></i> View
                        </button>
                        <button onclick="markAsContacted(${index})" style="background: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                            <i class="fas fa-check"></i> Contacted
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
            
            document.getElementById('customersTable').style.display = 'table';
            document.getElementById('error').style.display = 'none';
            document.getElementById('noData').style.display = 'none';
            
            console.log('‚úÖ Fallback data shown successfully');
        }
        
        function updateStats(data) {
            const totalContacts = data.length;
            const newMessages = data.filter(c => (c.status || 'new') === 'new').length;
            
            // Count today's contacts
            const today = new Date().toDateString();
            const todayContacts = data.filter(c => {
                try {
                    const contactDate = new Date(c.created_at || c.timestamp).toDateString();
                    return contactDate === today;
                } catch (e) {
                    return false;
                }
            }).length;
            
            // Calculate response rate
            const contactedMessages = data.filter(c => (c.status || 'new') === 'contacted' || (c.status || 'new') === 'resolved').length;
            const responseRate = totalContacts > 0 ? Math.round((contactedMessages / totalContacts) * 100) : 0;
            
            document.getElementById('totalContacts').textContent = totalContacts;
            document.getElementById('newMessages').textContent = newMessages;
            document.getElementById('todayContacts').textContent = todayContacts;
            document.getElementById('responseRate').textContent = responseRate + '%';
            
            console.log('üìä Stats updated:', { totalContacts, newMessages, todayContacts, responseRate });
        }
        
        function viewContact(index) {
            const customer = customerData[index];
            if (customer) {
                const message = customer.message || customer.query || 'No message';
                const details = `
üìã CONTACT DETAILS:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
üë§ Name: ${customer.name}
üìß Email: ${customer.email}
üìû Phone: ${customer.phone || customer.number}
üìÖ Date: ${new Date(customer.created_at || customer.timestamp).toLocaleString()}
üìä Status: ${customer.status || 'new'}

üí¨ Message:
${message}
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
ID: ${customer.id || 'N/A'}
                `;
                alert(details);
            }
        }
        
        function markAsContacted(index) {
            if (confirm('Mark this contact as contacted?')) {
                // In a real app, you would send this to your backend
                alert('Contact marked as contacted! (In a real app, this would update the database)');
                // For demo, just update local data
                if (customerData[index]) {
                    customerData[index].status = 'contacted';
                    loadCustomerData(); // Refresh to show updated status
                }
            }
        }
        
        function exportToExcel() {
            if (customerData.length === 0) {
                alert('No data to export!');
                return;
            }
            
            let csv = 'ID,Name,Email,Phone,Message,Status,Date\n';
            
            customerData.forEach(customer => {
                const date = new Date(customer.created_at || customer.timestamp).toLocaleString();
                const message = (customer.message || customer.query || '').replace(/"/g, '""');
                
                csv += `"${customer.id || ''}","${customer.name || ''}","${customer.email || ''}","${customer.phone || customer.number || ''}","${message}","${customer.status || 'new'}","${date}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `customer_contacts_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert(`‚úÖ Exported ${customerData.length} contacts to CSV file!`);
        }
        
        // Test connection function
        async function testConnection() {
            console.log('üîß Testing connection to backend...');
            
            try {
                // Test 1: Check if test endpoint works
                const testResponse = await fetch('https://real-estate-agency-sxsd.onrender.com/test?_t=' + Date.now());
                console.log('Test endpoint:', testResponse.status, testResponse.ok);
                
                if (testResponse.ok) {
                    const testData = await testResponse.json();
                    console.log('Test endpoint response:', testData);
                }
                
                // Test 2: Check contacts endpoint
                const contactsResponse = await fetch('https://real-estate-agency-sxsd.onrender.com/contacts?_t=' + Date.now());
                console.log('Contacts endpoint:', contactsResponse.status);
                
                const rawText = await contactsResponse.text();
                console.log('Raw response length:', rawText.length);
                console.log('Raw response (first 200 chars):', rawText.substring(0, 200));
                
                // Test 3: Try health endpoint
                const healthResponse = await fetch('https://real-estate-agency-sxsd.onrender.com/health?_t=' + Date.now());
                console.log('Health endpoint:', healthResponse.status);
                
                if (healthResponse.ok) {
                    const healthData = await healthResponse.json();
                    console.log('Health check:', healthData);
                }
                
            } catch (error) {
                console.error('‚ùå Connection test failed:', error);
            }
        }
        
        // Run test on page load
        window.addEventListener('load', () => {
            console.log('üöÄ Admin page loaded');
            console.log('üë§ User Agent:', navigator.userAgent);
            console.log('üìç Current URL:', window.location.href);
            
            // Test connection after 1 second
            setTimeout(testConnection, 1000);
        });
        
        // Auto-refresh every 60 seconds
        setInterval(() => {
            if (!document.hidden) { // Only refresh if tab is visible
                console.log('üîÑ Auto-refreshing data...');
                loadCustomerData();
            }
        }, 60000);
        
        // Manual refresh button
        document.addEventListener('DOMContentLoaded', () => {
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) {
                refreshBtn.addEventListener('click', () => {
                    console.log('üîÑ Manual refresh triggered');
                    loadCustomerData();
                });
            }
        });
    </script>
</body>
</html>